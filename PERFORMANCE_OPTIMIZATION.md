# 移動端性能優化說明

## 🎮 優化概述

本遊戲已針對移動設備進行全面性能優化，通過自動檢測設備類型和性能等級，動態調整渲染品質和特效數量。

## ⚡ 性能模式

### 三種性能模式

1. **高性能模式 (High)** - 桌面設備
   - 完整的視覺特效
   - 8個演唱會聚光燈
   - 完整的粒子系統
   - 激光射線和頻閃效果
   - 12個閃光粒子

2. **中等性能模式 (Medium)** - 較新的移動設備
   - 適度減少特效
   - 4個演唱會聚光燈
   - 減少粒子數量 (8個閃光粒子)
   - 保留部分光圈漣漪效果
   - 降低節拍頻率

3. **低性能模式 (Low)** - 一般移動設備
   - 極簡特效
   - 禁用演唱會燈光系統
   - 最少的粒子數量 (6個)
   - 簡化玩家繪製
   - 降低Canvas分辨率 (80%)
   - 關閉圖像平滑

## 🔧 具體優化措施

### 1. Canvas 優化
```typescript
// 禁用透明度通道，提升性能
alpha: false

// 降低延遲
desynchronized: true

// 低性能模式關閉圖像平滑
imageSmoothingEnabled = false
```

### 2. 分辨率調整
- 低性能模式：Canvas尺寸縮減至80%
- 減少需要渲染的像素總量

### 3. 金光/銀光觸發優化（重要！）
#### 冷卻時間控制
- **移動端**: 2秒冷卻（避免觸控時頻繁觸發）
- **桌面端**: 0.8秒冷卻
- **移動敏感度**: 需要更大的移動量才計數（2px vs 1px）

#### 光圈數量嚴格限制
- **移動端金光**: **最多4-5圈**（不會超過5圈）
- **桌面端金光**: 3-6圈（根據性能模式）
- **移動端銀光**: **最多4-5圈**
- **桌面端銀光**: 3-6圈

#### 衰減速度
- **移動端**: 2.5倍速度衰減（0.02 vs 0.008）
- **桌面端**: 正常速度
- 效果：移動端光效更快消失，減少重疊

### 4. 特效分級

#### 演唱會燈光系統
- **高性能**: 8個聚光燈 + 激光 + 頻閃
- **中等性能**: 4個聚光燈，無激光
- **低性能**: 完全禁用

#### 粒子系統
- **高性能**: 完整粒子（12個閃光粒子 + 拖尾）
- **中等性能**: 減半粒子（8個閃光粒子 + 少量拖尾）
- **低性能**: 最小粒子（6個閃光粒子，無拖尾）

#### 背景元素
- **高性能**: 50個星星
- **中等性能**: 30個星星
- **低性能**: 20個星星

#### 玩家繪製
- **高性能/中等**: 完整的液態金屬電吉他
- **低性能**: 簡化矩形版本，無複雜漸變和陰影

### 4. 視覺效果優化

#### 金光/銀光效果（已針對觸控優化）
移動端（嚴格限制）：
- **觸發頻率**: 最快每2秒一次
- **光圈數量**: **最多4-5圈**
- **衰減速度**: 2.5倍加速
- **閃光粒子**: 4-6個
- **光圈漣漪**: 僅1個

桌面端（完整效果）：
- **觸發頻率**: 最快每0.8秒一次
- **高性能**: 6層光暈 + 12個粒子 + 星光射線
- **中等性能**: 5層光暈 + 8個粒子
- **低性能**: 3層光暈 + 6個粒子

#### 震動波和光圈
- **高性能**: 完整效果
- **中等性能**: 僅光圈漣漪
- **低性能**: 完全禁用

## 📊 性能提升預期

### 移動設備 (低性能模式)
- **渲染負載**: 降低約 70%
- **幀率提升**: 2-3倍
- **電池消耗**: 減少約 50%

### 較新移動設備 (中等性能模式)
- **渲染負載**: 降低約 40%
- **幀率提升**: 1.5-2倍
- **視覺效果**: 保留約 60%

## 🎯 自動檢測邏輯

```typescript
// 檢測移動設備
isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)

// 根據設備特徵判斷性能等級
if (isMobile) {
  if (devicePixelRatio >= 2 && innerWidth >= 375) {
    // 較新設備 -> 中等性能
  } else {
    // 一般設備 -> 低性能
  }
} else {
  // 桌面 -> 高性能
}
```

## 💡 使用建議

1. **自動優化**: 遊戲會自動檢測並應用適當的性能模式
2. **無需手動設置**: 用戶無需任何操作
3. **流暢體驗**: 移動端應該能達到穩定的 30-60 FPS
4. **桌面端**: 保持完整的視覺效果和特效
5. **觸控優化**: 移動時金光不會頻繁出現，避免卡頓

## 🔍 監控方式

遊戲啟動時會在控制台輸出：
```
🎮 性能模式: low/medium/high, 移動設備: true/false
```

## 📝 後續優化方向

如果仍有性能問題，可考慮：
1. 進一步降低敵機生成頻率
2. 簡化子彈繪製（減少光暈效果）
3. 使用對象池減少GC壓力
4. 考慮使用 OffscreenCanvas
5. 降低遊戲更新頻率（requestAnimationFrame 節流）

## ⚠️ 注意事項

- 性能模式在遊戲啟動時確定，不會動態切換
- 低性能模式犧牲了部分視覺效果，但核心玩法完全保留
- **移動端觸控優化**: 金光/銀光最多5圈，冷卻時間2秒
- 桌面端保持完整特效，不受影響
- 建議在實際移動設備上測試以驗證優化效果

## 🎯 專門針對觸控的優化

### 問題：觸控移動時金光太頻繁
**解決方案**:
1. ✅ 移動端冷卻時間延長至2秒
2. ✅ 移動敏感度降低（需要2px移動才計數）
3. ✅ 光圈嚴格限制在3-4層（最多5圈）
4. ✅ 衰減速度加快2.5倍
5. ✅ 閃光粒子減少至4-6個
6. ✅ 光圈漣漪只創建1個

### 效果對比
| 項目 | 優化前（移動端） | 優化後（移動端） | 桌面端 |
|------|---------------|----------------|--------|
| 冷卻時間 | 無 | 2秒 | 0.8秒 |
| 光圈層數 | 6-7層 | **3-4層（最多5圈）** | 3-6層 |
| 衰減速度 | 1x | **2.5x** | 1x |
| 閃光粒子 | 12個 | **4-6個** | 6-12個 |
| 光圈漣漪 | 3個 | **1個** | 3個 |

